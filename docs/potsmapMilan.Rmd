---
title: "Map of Ariannas in Milan"
output:
  html_document:
    df_print: paged
---


loading libraries data from tsData.csv


```{r}
library(ggplot2)
library(forcats)
library(data.table)
library(chron)
library(fasttime)
library(svglite)
library(raster)
library(ggmap)
library(extraoperators)

#setting parent directory as working directory

currentDir=getwd()

parentDir=dirname(currentDir)

setwd(parentDir)

#reading data

tsData=fread("data/tsData.csv")

head(tsData)


```

aggregating all data to leave just potID and longitude, latitude

```{r}
locationData=tsData[,j=.(longitude=min(longitude),latitude=min(latitude)),by=.(pot_id)]

head(locationData)
```
Now we create the dataset with the coordinates of the four ARPA stations in Milan

(source: https://www.arpalombardia.it/Pages/Aria/Qualita-aria.aspx?mappa=sf)

```{r}
coordArpa=data.table(lat=c(45.463372,45.470642,45.478561,45.496316),
                     lon=c(9.195340,9.197197,9.232380,9.190943))




```



Fixing geographical limits of the map displayed and selecting the pots which are 
located in Milan. 

image file with the map is saved in potsMap.jpg
```{r}
topL=45.539
bottomL=45.405
leftL=9.08
rightL=9.31

# get the Map of Milan
MilanMap=get_stamenmap(bbox = c(left=leftL,right=rightL,top=topL,bottom=bottomL),maptype = 'terrain',zoom=12)

# selecting only pots on Milan area
MilanPots=locationData[(longitude %gele% c(leftL,rightL) & latitude %gele% c(bottomL,topL)),]

print.default(paste("number of pots displayed: ",dim(MilanPots)[1]))

# plotting just ARPA Stations
arpaMap=ggmap(MilanMap) + 
  geom_point(data=coordArpa,aes(x=lon,y=lat,colour="ARPA"),alpha=.7,size=2) +
  labs(title='Milan',y='Latitude (WGS84)',x='Longitude (WGS84)',color='Legend') +
  scale_color_manual(values = c("ARPA"="blue","Wiseair"="red"))

arpaMap

ggsave(filename="arpaMap.jpg",plot=arpaMap,width=7, height=6)

# plotting ARPA + Wiseair
potsMap=ggmap(MilanMap) + 
  geom_point(data=MilanPots,aes(x=longitude,y=latitude,colour="Wiseair"),alpha=.7,size=2)+
  geom_point(data=coordArpa,aes(x=lon,y=lat,colour="ARPA"),alpha=.7,size=2)+
  labs(title='Milan',y='Latitude (WGS84)',x='Longitude (WGS84)', color="Legend") + 
  scale_color_manual(values = c("ARPA"="blue","Wiseair"="red"))

potsMap

ggsave(filename="potsMap.jpg",plot=potsMap,width=7, height = 6)

```

producing some plots to show time irregularity.



```{r}


#setting parent directory as working directory

currentDir=getwd()

parentDir=dirname(currentDir)

setwd(parentDir)

#loading raw data

wiseairdata=fread("data/rawdata.csv", drop = 16)

# converting dates and time to POSIXct class (very fast)

wiseairdata$created_at = fastPOSIXct(wiseairdata$created_at)

# converting pot_id variable into a factor  (fast)
wiseairdata$pot_id = as.factor(wiseairdata$pot_id)


# aggregating (fast) data to create a pot database (computing the number of measure, first date of measure, mean frequency of measure,)
potdatabase=wiseairdata[,list(max_cfm=max(consecutive_failed_measures),
                              nr_measures=.N, 
                              firstdate=min(created_at), 
                              meanfreq=mean(seconds_until_next_measure), 
                              maxfreq=max(seconds_until_next_measure),
                              minfreq=min(seconds_until_next_measure)  ),by=list(pot_id)]

ggplot(potdatabase,aes(x=pot_id,y=firstdate)) +
  geom_point() +
   coord_flip() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x='station id',y='time of first measure')


```
Now we plot some time series to show an example of time irregularity

```{r}
ggplot(wiseairdata[(pot_id==1103 | pot_id==1014) & created_at %gele% c("2020-09-23","2020-09-25"),],aes(x=created_at,y=pm2p5,color=pot_id)) +
  geom_point(size=1) + geom_line() +labs(x="time of measurement",y="PM2.5")

ggsave(filename="timeIrregularity.png",width=9,height=5)
```





